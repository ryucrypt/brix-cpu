<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="96x96" href="res/favi.png">
    <title>Brix Society CPU Partnership</title>
    <meta property="og:title" content="Brix Society CPU Partnership">
    <meta property="og:image" content="https://cpurent.brixsociety.io/res/favi.png">
    <meta property="og:description" content="Setup your partnership wallet.">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B87M2XWYB9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B87M2XWYB9');
    </script>
</head>
<body>
    <div class="container">
        <div class="modal fade" id="login" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loginLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="loginLabel">Select wallet</h1>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row">
                                <div id="login_msg" class="alert alert-danger visually-hidden mb-3" role="alert"></div>
                            </div>
                            <div class="row mb-3">
                                <button class="btn" style="color:white;background-color:rgb(54, 80, 162)" onclick="login('anchor');"><img src="res/anchor.svg" class="float-start" height="24">Anchor</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <header class="d-flex flex-wrap justify-content-center text-center py-3 mb-4 border-bottom">
            <a href="https://brixsociety.io" target="_blank" class="navbar-brand me-auto text-light text-wrap" style="font-family:'Press Start 2P'">
                <h2>BRIX SOCIETY CPU PARTNERSHIP</h2>
            </a>
            <ul class="nav nav-pills">
                <li class="nav-item" id="loginbtn"><a href="javascript:void(0)" class="nav-link active" aria-current="page" data-bs-toggle="modal" data-bs-target="#login">Login</a></li>
                <li class="nav-item dropdown visually-hidden" id="wallet">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">wallet</a>
                    <ul class="dropdown-menu" id="balances">
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="logout()">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </header>
        <main>
            <div class="row mb-3">
                <div class="accordion" id="about">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#about_content" aria-expanded="true" aria-controls="about_content">
                            What does this tool do?
                        </button>
                      </h2>
                      <div id="about_content" class="accordion-collapse collapse" data-bs-parent="#about">
                        <div class="accordion-body">
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Your account permissions will be modified, tread carefully!
                            </div>
                            This tool setups the neccessary permissions for our contract to interact with your partnership wallet.
                        </div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="row mb-3 container">
                <h3><u>Steps:</u></h3>
                <ol>
                    <li class="mb-2">
                        Make sure you are on desktop, the following steps are meant for Anchor desktop.
                    </li>
                    <li class="mb-2">
                        Launch Anchor and navigate to Settings.<br>
                        <img class="img-fluid" width="480" src="res/1.png">
                    </li>
                    <li class="mb-2">
                        Scroll down and change the "Allow dangerous transactions in URI signer" setting to "Allow dangerous transactions".<br>
                        <img class="img-fluid" width="480" src="res/2.png">
                    </li>
                    <li class="mb-2">
                        Login using the button on the top right of this page. Remember to login using the target account with <code>@active</code> permission.
                        <img class="img-fluid" width="480" src="res/3.png">
                    </li>
                    <li class="mb-2">
                        Click the button below and sign the transaction.
                    </li>
                </ol>
                <div class="col-auto d-flex align-items-center">
                    <button type="submit" class="btn btn-primary" onclick="run()">Submit</button>
                </div>
                <div id="err_msg" class="alert alert-danger visually-hidden mt-3" role="alert"></div>
                <div id="pass_msg" class="alert alert-success visually-hidden mt-3" role="alert"></div>
                <ol class="mt-3" start="6">
                    <li class="mb-2">
                        Navigate to <a href="javascript:void(0)" id="explorer">the block explorer</a>. Under the "Keys" tab you should see <code>@cpu</code> as a child of <code>@active</code>, which is authorized to <code>rentcpu.brix@eosio.code</code>.<br>
                        Permissions are only granted for:
                        <ul>
                            <li><code>eosio::delegatebw</code></li>
                            <li><code>eosio::undelegatebw</code></li>
                            <li><code>eosio::refund</code></li>
                        </ul>
                        <img class="img-fluid" width="480" src="res/4.png">
                    </li>
                </ol>
            </div>
        </main>
        <footer>
            <div class="row justify-content-center border-top">
                <p class="text-center text-muted my-3">Made by ryucrypt: wwiem.wam</p>
            </div>
        </footer>
    </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/anchor-link@3"></script>
<script src="https://unpkg.com/anchor-link-browser-transport@3"></script>
<script src="js/waxjs.js"></script>
<script src="js/scatterjs-core-min.js"></script>
<script src="js/scatterjs-plugin-eosjs2.min.js"></script>
<script src="js/externals.min.js"></script>
<script src="js/eosjs-api.min.js"></script>
<script src="js/eosjs-jsonrpc.min.js"></script>
<script src="js/wallets.js"></script>
<script>
const EXPLORER = "https://waxblock.io/transaction/";
const ACC = "https://waxblock.io/account/";
var wallet = "";
var perms = "";
var loggedin = false;

String.prototype.format = function () {
    var args = arguments;
    return this.replace(/{([0-9]+)}/g, function (match, index) {
        return typeof args[index] == 'undefined' ? match : args[index];
    });
};

const formatToken = (precision, amount) => {
    return (+(Math.round(+(amount + 'e' + precision)) + 'e' + -precision)).toFixed(precision);
}

const setErr = (msg) => {
    $("#err_msg").text(msg);
    $("#err_msg").removeClass("visually-hidden");
}

const setPass = (msg) => {
    $("#pass_msg").html(msg);
    $("#pass_msg").removeClass("visually-hidden");
}

const logout = async() => {
    await wallet_logout();
    $("#loginbtn").toggleClass("visually-hidden");
    $("#wallet").toggleClass("visually-hidden");
    $("#err_msg").addClass("visually-hidden");
    $("#pass_msg").addClass("visually-hidden");
    loggedin = false;
}

const login = async(walletType) => {
    if (walletType) {
        wallet_selectWallet(walletType);
    }

    try {
        $("#login_msg").addClass("visually-hidden");
        wallet = await wallet_login();
        perms = wallet.split("@")[1];
        wallet = wallet.split("@")[0];
        $("#wallet a:first").text(wallet);
        $("#explorer").attr("href", ACC + wallet);
        $("#explorer").attr("target", "_blank");
        $("#loginbtn").addClass("visually-hidden");
        $("#wallet").removeClass("visually-hidden");
        bootstrap.Modal.getOrCreateInstance("#login").hide();
        loggedin = true;
        $("#err_msg").addClass("visually-hidden");
    } catch(e) {
        $("#login_msg").removeClass("visually-hidden");
        $("#login_msg").text(e.message);
    }
}

const run = async() => {
    $("#err_msg").addClass("visually-hidden");
    $("#pass_msg").addClass("visually-hidden");

    if (!loggedin) {
        setErr("Please login first");
        return;
    }

    try {
        var actions = [
            {
                "account": "eosio",
                "name": "updateauth",
                "authorization": [{
                    "actor": wallet,
                    "permission": perms
                }],
                "data": {
                    "account": wallet,
                    "permission": "cpu",
                    "parent": "active",
                    "auth": {
                        "threshold": 1,
                        "keys": [],
                        "accounts": [{
                            "permission": {
                                "actor": "rentcpu.brix",
                                "permission": "eosio.code"
                            },
                            "weight": 1
                        }],
                        "waits": []
                    },
                    "authorized_by": null
                }
            },
            {
                "account": "eosio",
                "name": "linkauth",
                "authorization": [{
                    "actor": wallet,
                    "permission": perms
                }],
                "data": {
                    "account": wallet,
                    "code": "eosio",
                    "type": "delegatebw",
                    "requirement": "cpu",
                    "authorized_by": null
                }
            },
            {
                "account": "eosio",
                "name": "linkauth",
                "authorization": [{
                    "actor": wallet,
                    "permission": perms
                }],
                "data": {
                    "account": wallet,
                    "code": "eosio",
                    "type": "undelegatebw",
                    "requirement": "cpu",
                    "authorized_by": null
                }
            },
            {
                "account": "eosio",
                "name": "linkauth",
                "authorization": [{
                    "actor": wallet,
                    "permission": perms
                }],
                "data": {
                    "account": wallet,
                    "code": "eosio",
                    "type": "refund",
                    "requirement": "cpu",
                    "authorized_by": null
                }
            }
        ];
        var txn = await wallet_transact(actions);
        setPass("Success! <a href='{0}{1}' target='_blank'>View Transaction</a>".format(EXPLORER, txn.transaction_id));
    } catch(e) {
        setErr(e.message);
    }
}
</script>
</body>
</html>